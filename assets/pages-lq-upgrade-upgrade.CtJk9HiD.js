import{P as e,L as t,Q as s,R as a,S as n,T as l,c as o,w as i,i as r,b as d,e as c,f as p,t as u,n as h,g as f,x as m,q as g}from"./index-CfnFCTXe.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";const _=(e=()=>{})=>{let t=plus.android.runtimeMainActivity(),s=plus.android.implements("io.dcloud.android.content.BroadcastReceiver",{onReceive:(a,n)=>{plus.android.importClass(n),t.unregisterReceiver(s),e()}}),a=plus.android.importClass("android.content.IntentFilter"),n=plus.android.importClass("android.content.Intent"),l=new a;l.addAction(n.ACTION_PACKAGE_ADDED),l.addDataScheme("package"),t.registerReceiver(s,l)};const v=w({data:()=>({isForceUpdate:!1,versionName:"",versionDesc:"",downloadUrl:"",isDownloadFinish:!1,hasProgress:!1,currentPercent:0,isStartDownload:!1,fileName:""}),computed:{setProStyle(){return{width:510*this.currentPercent/100+"rpx"}},percentText(){let e=this.currentPercent;return"number"!=typeof e||isNaN(e)?"下载中...":e<100?`下载中${e}%`:"立即安装"}},onBackPress(e){if("backbutton"==e.from)return!0},created(){s("upgrade-app",this.bindEmit)},beforeDestroy(){a("upgrade-app",this.bindEmit)},methods:{bindEmit(e){let{name:t,content:s,url:a,forceUpdate:n}=e;this.isForceUpdate=n,this.versionName=t,this.versionDesc=s,this.downloadUrl=a},handleUpgrade(){if(this.downloadUrl){let t=this.downloadUrl.split("/"),s=`_downloads/${t[t.length-1]}`,a=plus.io.convertLocalFileSystemURL(s);const l=this;n({filePath:a,success:e=>{l.isDownloadFinish=!0,l.fileName=s,l.handleInstallApp()},fail:t=>{l.isStartDownload=!0,((t,s=()=>{})=>new Promise(((a,n)=>{const l=plus.downloader.createDownload(t,{method:"GET"},((t,s)=>{console.log(s,"status"),200==s?a(t.filename):(n("fail"),e({title:"下载失败",duration:1500,icon:"none"}))}));l.addEventListener("statechanged",((e,t)=>{switch(e.state){case 1:case 2:break;case 3:if(console.log(e,"task"),e.totalSize&&e.totalSize>0){let t=parseInt(100*e.downloadedSize/e.totalSize);s(t,e.downloadedSize,e.totalSize)}}})),l.start()})))(l.downloadUrl,(e=>{l.hasProgress=!0,l.currentPercent=e})).then((e=>{l.isDownloadFinish=!0,l.fileName=e,e&&l.handleInstallApp()})).catch((e=>{console.log("下载失败：",e)}))}})}else e({title:"下载链接不存在",icon:"none"})},handleInstallApp(){this.isDownloadFinish&&this.fileName&&((s,a,n=()=>{})=>{_(n),plus.runtime.install(plus.io.convertLocalFileSystemURL(s),{force:!0},(()=>{e({title:"成功跳转到安装界面",duration:1500,icon:"none"})}),(function(e){t({title:"安装失败",content:JSON.stringify(e),showCancel:!1,confirmText:"我知道了"})}))})(this.fileName,this.isForceUpdate,(()=>{l()}))},handleClose(){l()}}},[["render",function(e,t,s,a,n,l){const w=m,_=r,v=g;return d(),o(_,{class:"upgrade-popup"},{default:i((()=>[c(w,{class:"header-bg",src:"/assets/upgrade_bg-CblIhj4w.png",mode:"widthFix"}),c(_,{class:"main"},{default:i((()=>[c(_,{class:"version"},{default:i((()=>[p("发现新版本"+u(n.versionName),1)])),_:1}),c(_,{class:"content"},{default:i((()=>[c(v,{class:"title"},{default:i((()=>[p("更新内容")])),_:1}),c(_,{class:"desc",innerHTML:n.versionDesc},null,8,["innerHTML"])])),_:1}),n.isStartDownload?(d(),o(_,{key:0,class:"footer"},{default:i((()=>[c(_,{class:h(["progress-view",{active:!n.hasProgress}]),onClick:l.handleInstallApp},{default:i((()=>[n.hasProgress?(d(),o(_,{key:0,style:{height:"100%"}},{default:i((()=>[c(_,{class:"txt"},{default:i((()=>[p(u(l.percentText),1)])),_:1}),c(_,{class:"progress",style:f(l.setProStyle)},null,8,["style"])])),_:1})):(d(),o(_,{key:1},{default:i((()=>[c(_,{class:"btn upgrade force"},{default:i((()=>[p(u(n.isDownloadFinish?"立即安装":"下载中..."),1)])),_:1})])),_:1}))])),_:1},8,["class","onClick"])])),_:1})):n.isForceUpdate?(d(),o(_,{key:1,class:"footer"},{default:i((()=>[c(_,{class:"btn upgrade force",onClick:l.handleUpgrade},{default:i((()=>[p("立即更新")])),_:1},8,["onClick"])])),_:1})):(d(),o(_,{key:2,class:"footer"},{default:i((()=>[c(_,{class:"btn close yh",onClick:l.handleClose},{default:i((()=>[p("以后再说")])),_:1},8,["onClick"]),c(_,{class:"btn upgrade",onClick:l.handleUpgrade},{default:i((()=>[p("立即更新")])),_:1},8,["onClick"])])),_:1}))])),_:1})])),_:1})}],["__scopeId","data-v-0327b6d6"]]);export{v as default};
